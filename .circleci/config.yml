version: 2.1

jobs:
  backend_build_and_test:
    docker:
      - image: circleci/python:3.7.2
        environment:
          INTEL_BUFFER_DB_USER: root
          INTEL_BUFFER_DB_PASS: pass
          REDIS_DB_PASS: pass

      - image: circleci/mysql:latest
        environment:
          MYSQL_HOST: 127.0.0.1
          MYSQL_PORT: 3306
          MYSQL_DB: intel_buffer_test_db
          MYSQL_USER: root
          MYSQL_PASSWORD: pass

    steps:
      - checkout

      - restore_cache:
          keys:
          - v1-x-{{ .Branch }}-{{ checksum "backend/Pipfile.lock" }}
          - v1-x-

      - run:
          name: grant circleci access to dependency locations
          command: |
            sudo chown -R circleci:circleci /usr/local/bin
            sudo chown -R circleci:circleci /usr/local/lib/python3.7/site-packages

      - run:
          name: install pipenv
          command: cd backend && sudo pip install pipenv

      - run:
          name: install dependencies
          command: cd backend && pipenv install --dev

      - save_cache:
          key: v1-x-{{ .Branch }}-{{ checksum "backend/Pipfile.lock" }}
          paths:
            - ".venv"
            - "/usr/local/bin"
            - "/usr/local/lib/python3.7/site-packages"

      - run:
          name: run tests with coverage and statistics from hypothesis
          command: cd backend && pipenv run python -m pytest --cov --hypothesis-show-statistics

  frontend_build_and_test:
    docker:
      - image: circleci/node:11.6.0

    steps:
      - checkout

      - restore_cache:
          keys:
          - intel-buffer-frontend-{{ .Branch }}-{{ checksum "frontend/package.json" }}
          - intel-buffer-frontend-

      # TODO: find a better way so 'cd' doesn't have to be done a million times
      - run: cd frontend && npm install

      - save_cache:
          paths:
            - node_modules
          key: intel-buffer-frontend-{{ .Branch }}-{{ checksum "frontend/package.json" }}

      - run: cd frontend && npm run test:unit
      - run: cd frontend && npm run build

workflows:
  version: 2.1
  build_and_test:
    jobs:
      - frontend_build_and_test
      - backend_build_and_test
