version: 2.1

jobs:
  build:
    docker:
      - image: circleci/python:3-node
        environment:
          FLASK_SECRET_KEY: testing
          INTEL_BUFFER_DB_USER: root
          INTEL_BUFFER_DB_PASS: pass
          REDIS_DB_PASS: pass

      - image: circleci/mysql:latest
        command: |
          mysqld --character-set-server=utf8mb4 --collation-server=utf8mb4_general_ci
        environment:
          MYSQL_HOST: 127.0.0.1
          MYSQL_PORT: 3306
          MYSQL_DATABASE: intel_buffer_test_db
          MYSQL_ROOT_PASSWORD: pass

    steps:
      - checkout

      - run:
          name: grant circleci access to backend dependency locations
          command: |
            sudo chown -R circleci:circleci /usr/local/bin
            sudo chown -R circleci:circleci /usr/local/lib/python3.7/site-packages 

      - restore_cache:
          keys:
          - ib-{{ .Branch }}-{{ checksum "backend/Pipfile.lock" }}-{{ checksum "frontend/package.json" }}
          - ib-

      - run:
          name: install pipenv
          command: cd backend && pip install pipenv

      - run:
          name: install all backend dependencies
          command: cd backend && pipenv install --dev

      - run:
          name: install frontend dependencies
          command: cd frontend && npm install

      - save_cache:
          key: ib-{{ .Branch }}-{{ checksum "backend/Pipfile.lock" }}-{{ checksum "frontend/package.json" }}
          paths:
            - ".venv"
            - "/usr/local/bin"
            - "/usr/local/lib/python3.7/site-packages"
            - node_modules

      - run:
          name: run frontend tests
          command: cd frontend && npm run test:unit

      - run:
          name: build frontend files
          command: cd frontend && npm run build

      - run:
          name: run backend tests
          command: cd backend && pipenv run python -m pytest --cov

